import{D as u,C as a,E as g,G as c,_ as l}from"./index.e515a6fe.js";const h={async getSongAudioBlob(e){var t,r,n;try{const s=`${u.QUEUE}/songs/${e}`;return(await a.get(s,{responseType:"blob"})).data}catch(s){throw console.error("Error fetching song audio:",s),((t=s.response)==null?void 0:t.status)===404?new Error("Song not found"):((r=s.response)==null?void 0:r.status)===401?new Error("Unauthorized - please log in again"):((n=s.response)==null?void 0:n.status)===500?new Error("Server error - please try again later"):s.request?new Error("Network error - please check your connection"):new Error("Failed to load song")}},async getSongLikedStatus(e){var t,r,n,s;try{const i=`${u.QUEUE}/songs/${e}/liked`;return(await a.get(i)).data}catch(i){throw console.error("Error fetching song liked status:",i),((t=i.response)==null?void 0:t.status)===404?new Error("Song not found"):((r=i.response)==null?void 0:r.status)===401?new Error("Unauthorized - please log in again"):((n=i.response)==null?void 0:n.status)===400?new Error("Bad request - song not found"):((s=i.response)==null?void 0:s.status)===500?new Error("Server error - please try again later"):i.request?new Error("Network error - please check your connection"):new Error("Failed to get liked status")}},async markSongAsLiked(e){var t,r,n,s;try{const i=`${u.QUEUE}/songs/${e}/liked`;await a.post(i)}catch(i){throw console.error("Error marking song as liked:",i),((t=i.response)==null?void 0:t.status)===404?new Error("Song not found"):((r=i.response)==null?void 0:r.status)===401?new Error("Unauthorized - please log in again"):((n=i.response)==null?void 0:n.status)===400?new Error("Bad request - song not found"):((s=i.response)==null?void 0:s.status)===500?new Error("Server error - please try again later"):i.request?new Error("Network error - please check your connection"):new Error("Failed to mark song as liked")}},async markSongAsUnliked(e){var t,r,n,s;try{const i=`${u.QUEUE}/songs/${e}/unliked`;await a.post(i)}catch(i){throw console.error("Error marking song as unliked:",i),((t=i.response)==null?void 0:t.status)===404?new Error("Song not found"):((r=i.response)==null?void 0:r.status)===401?new Error("Unauthorized - please log in again"):((n=i.response)==null?void 0:n.status)===400?new Error("Bad request - song not found"):((s=i.response)==null?void 0:s.status)===500?new Error("Server error - please try again later"):i.request?new Error("Network error - please check your connection"):new Error("Failed to mark song as unliked")}}},S=g("player",{state:()=>({currentSong:null,isPlaying:!1,currentTime:0,duration:0,volume:.5,queue:[],currentIndex:-1,shuffle:!1,repeat:!1,audioElement:null,currentObjectUrl:null,isSongEndingNaturally:!1,isNavigating:!1,isLiked:!1}),getters:{hasNext:e=>e.repeat==="all"?e.queue.length>0:e.currentIndex<e.queue.length-1,hasPrevious:e=>e.repeat==="all"?e.queue.length>0:e.currentIndex>0,progress:e=>e.duration?e.currentTime/e.duration*100:0},actions:{async fetchLikedStatus(e){if(!e){this.isLiked=!1;return}try{const t=await h.getSongLikedStatus(e);this.isLiked=t.liked||!1}catch{this.isLiked=!1}},async toggleLiked(){var r;if(!((r=this.currentSong)!=null&&r.id))return;const e=this.currentSong.id,t=this.isLiked;this.isLiked=!t;try{t?await h.markSongAsUnliked(e):await h.markSongAsLiked(e)}catch(n){this.isLiked=t,console.error("Failed to toggle liked status:",n)}},async markCurrentSongAsSkipped(){var t;if(!((t=this.currentSong)!=null&&t.id)||this.isSongEndingNaturally)return;const e=this.currentSong.id;try{await c.markSongAsSkipped(e),this.refreshQueueAfterEvent()}catch{}},async markCurrentSongAsFinished(){var t;if(!((t=this.currentSong)!=null&&t.id))return;const e=this.currentSong.id;try{await c.markSongAsFinished(e),this.refreshQueueAfterEvent()}catch{}},async refreshQueueAfterEvent(){try{const{useQueueStore:e}=await l(()=>import("./index.e515a6fe.js").then(r=>r.J),["assets/index.e515a6fe.js","assets/index.81150bca.css"]);e().fetchQueue().catch(()=>{})}catch{}},selectFirstUnplayedSong(){var t;if(this.queue.length===0)return null;if((t=this.currentSong)!=null&&t.id)return this.currentSong;const e=this.queue.findIndex(r=>{var s,i;const n=(i=r.listenCount)!=null?i:(s=r.userSong)==null?void 0:s.listenCount;return!n||n===0});return e>=0?(this.currentIndex=e,this.currentSong=this.queue[e],this.queue[e]):null},setAudioElement(e){this.audioElement=e,e&&(e.volume=this.volume,e.addEventListener("timeupdate",()=>{this.currentTime=e.currentTime*1e3}),e.addEventListener("loadedmetadata",()=>{this.duration=e.duration*1e3}),e.addEventListener("ended",()=>{this.handleSongEnd()}))},async play(e){var t,r,n;if(((t=this.currentSong)==null?void 0:t.id)===e.id&&((r=this.audioElement)==null?void 0:r.src)){this.resume();return}if(((n=this.currentSong)==null?void 0:n.id)&&this.currentSong.id!==e.id&&!this.isSongEndingNaturally&&!this.isNavigating&&this.markCurrentSongAsSkipped(),this.currentObjectUrl&&(URL.revokeObjectURL(this.currentObjectUrl),this.currentObjectUrl=null),!this.audioElement||!e.id){this.isNavigating=!1;return}this.isSongEndingNaturally=!1,this.isNavigating=!1;try{const s=await h.getSongAudioBlob(e.id),i=URL.createObjectURL(s);this.currentObjectUrl=i,this.currentSong=e,this.fetchLikedStatus(e.id),this.audioElement.src=i,this.audioElement.load(),await this.audioElement.play(),this.isPlaying=!0}catch(s){console.error("Error playing song:",s),s.message?console.warn(`Failed to play song: ${s.message}`):console.warn("Failed to play song. Please try again.");const{isSongNotWorking:i}=await l(()=>import("./songHelpers.84ed5525.js"),[]);if(e&&i(e,s)){console.warn(`Song ${e.id} appears to be not working, removing from queue`);try{const{useQueueStore:o}=await l(()=>import("./index.e515a6fe.js").then(d=>d.J),["assets/index.e515a6fe.js","assets/index.81150bca.css"]);await o().removeSongFromQueue(e.id)}catch(o){console.error("Failed to remove non-working song from queue:",o)}}this.currentSong=null,this.isPlaying=!1,this.queue.length>0&&this.next()}},pause(){this.audioElement&&(this.audioElement.pause(),this.isPlaying=!1)},resume(){if(!this.audioElement){if(!this.currentSong){const e=this.selectFirstUnplayedSong();if(e){this.play(e);return}}return}if(!this.currentSong&&this.queue.length>0){const e=this.selectFirstUnplayedSong();if(e){this.play(e);return}}this.currentSong&&this.audioElement&&this.audioElement.play().then(()=>{this.isPlaying=!0}).catch(e=>{console.error("Error resuming song:",e)})},togglePlay(){if(this.isPlaying)this.pause();else{if(!this.currentSong){const e=this.selectFirstUnplayedSong();if(e){this.play(e);return}return}this.resume()}},seekTo(e){this.audioElement&&(this.audioElement.currentTime=e/1e3,this.currentTime=e)},setVolume(e){this.volume=e,this.audioElement&&(this.audioElement.volume=e)},next(){var e;if(this.repeat==="one"&&this.currentSong){this.isNavigating=!0,this.play(this.currentSong);return}if(this.queue.length!==0)if(this.isNavigating=!0,((e=this.currentSong)==null?void 0:e.id)&&!this.isSongEndingNaturally&&this.markCurrentSongAsSkipped(),this.hasNext){const t=this.currentIndex+1;t<this.queue.length&&(this.currentIndex=t,this.play(this.queue[t]))}else this.currentIndex=0,this.queue.length>0&&this.play(this.queue[0])},previous(){var e;if(this.repeat==="one"&&this.currentSong){this.isNavigating=!0,this.play(this.currentSong);return}if(this.isNavigating=!0,((e=this.currentSong)==null?void 0:e.id)&&!this.isSongEndingNaturally&&this.markCurrentSongAsSkipped(),this.hasPrevious){const t=this.currentIndex-1;t>=0&&(this.currentIndex=t,this.play(this.queue[t]))}else this.repeat==="all"&&this.queue.length>0&&(this.currentIndex=this.queue.length-1,this.play(this.queue[this.queue.length-1]))},toggleShuffle(){if(this.shuffle=!this.shuffle,this.shuffle&&this.queue.length>1){const e=[...this.queue];for(let t=e.length-1;t>0;t--){const r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}this.queue=e,this.currentIndex=this.queue.findIndex(t=>{var r;return t.id===((r=this.currentSong)==null?void 0:r.id)})}},toggleRepeat(){this.repeat===!1?this.repeat="all":this.repeat==="all"?this.repeat="one":this.repeat=!1},mergeQueue(e){if(!Array.isArray(e)||e.length===0)return;const t=new Set(this.queue.map(n=>n.id)),r=e.filter(n=>!t.has(n.id));r.length>0&&(this.queue=[...this.queue,...r])},setQueue(e,t=0,r=!1){if(r){if(this.mergeQueue(e),this.currentIndex>=0&&this.currentIndex<this.queue.length)return;if(this.currentSong){const n=this.queue.findIndex(s=>s.id===this.currentSong.id);if(n>=0){this.currentIndex=n;return}}}else{if(!Array.isArray(e)||e.length===0)return;this.queue=e;const n=Math.max(0,Math.min(t,e.length-1));this.currentIndex=n;const s=e[n];s&&s.id&&this.play(s)}},addToQueue(e){this.queue.push(e)},removeFromQueue(e){e===this.currentIndex?(this.queue.splice(e,1),this.queue.length>0?(this.currentIndex=Math.min(e,this.queue.length-1),this.play(this.queue[this.currentIndex])):(this.currentSong=null,this.isPlaying=!1,this.currentIndex=-1)):(this.queue.splice(e,1),e<this.currentIndex&&this.currentIndex--)},handleSongEnd(){var e;this.isSongEndingNaturally=!0,(e=this.currentSong)!=null&&e.id&&this.markCurrentSongAsFinished(),this.repeat==="one"?(this.isNavigating=!0,this.play(this.currentSong),this.isSongEndingNaturally=!1):this.next()},clear(){this.currentObjectUrl&&(URL.revokeObjectURL(this.currentObjectUrl),this.currentObjectUrl=null),this.currentSong=null,this.isPlaying=!1,this.currentTime=0,this.duration=0,this.queue=[],this.currentIndex=-1,this.isLiked=!1,this.audioElement&&(this.audioElement.pause(),this.audioElement.src="")}}});export{S as usePlayerStore};
